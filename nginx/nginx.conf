# 推荐根据 CPU 核心数设置，'auto' 是最佳实践
worker_processes auto;

# 增加文件句柄限制，应与 'worker_connections' 配合
# 在 systemd 或 init.d 中设置 (例如：ulimit -n 65536)
# worker_rlimit_nofile 65536;

events {
    # 增加连接数，需要配合系统 ulimit -n
    worker_connections 4096;
    
    # 启用 epoll 模型，在 Linux 下性能更优
    use epoll;
    
    # 允许 worker 进程一次性接受所有新连接
    multi_accept on;
}

http {
    # MIME 类型配置
    include mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # --- 性能优化 ---
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # --- 安全与限制 ---
    # 隐藏 Nginx 版本号
    server_tokens off; 
    
    # 客户端请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 允许的最大请求体，例如 16M (根据需求调整)
    client_max_body_size 16m; 
    
    # 客户端超时设置，防止慢连接攻击
    client_header_timeout 10s;
    client_body_timeout 10s;
    send_timeout 10s;

    # --- Gzip 压缩配置 ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_min_length 256;
    # 扩展 Gzip 类型，覆盖更多常见资源
    gzip_types 
        application/javascript 
        application/json 
        application/xml
        application/x-font-ttf
        application/vnd.ms-fontobject
        image/svg+xml
        font/opentype
        text/css 
        text/plain 
        text/xml;

    # --- Upstream 定义 ---
    
    # SSR 后端 (web-student)
    upstream ssr_backend {
        server web-student:3000;
        keepalive 32; 
    }

    # Admin 后端 (backend)
    upstream admin_backend {
        server backend:8000;
        keepalive 32; # 同样建议为 admin 后端启用
    }

    # --- Server 1: 前台应用 (端口 80) ---
    server {
        listen 80;
        server_name _; # 捕获所有未匹配的域名

        # ----------------------------------------------------
        # 定义一个命名位置 (@proxy_to_ssr) 用于 SSR 代理转发
        # ----------------------------------------------------
        location @proxy_to_ssr {
            proxy_pass http://ssr_backend;

            # --- 传递关键头信息 ---
            # [重要] 取消注释，后端应用通常需要 Host 头
            proxy_set_header Host $host; 
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # --- 启用 HTTP/1.1 和 Keep-Alive ---
            proxy_http_version 1.1;
            # [重要] 清空 Connection 头，以正确使用 upstream keepalive
            proxy_set_header Connection ""; 
        }

        # 根目录：优先尝试静态文件，失败则转发到 SSR
        location / {
            try_files $uri $uri/ @proxy_to_ssr;
        }

        # 静态资源 /assets
        location /assets {
            root /var/www/frontend;
            # 优化：为静态资源添加缓存头
            expires 1M; # 缓存 1 个月
            add_header Cache-Control "public, must-revalidate";
        }

        # Judge0 服务代理
        location /judge0/ {
            proxy_pass http://192.168.122.137:2358/;

            # 透传关键头信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 支持 WebSocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
        }
    }

    # --- Server 2: 后台管理 (端口 8080) ---
    server {
        listen 8080;
        server_name admin; # 明确指定 server_name

        # Admin 静态文件
        location /static/ {
            alias /var/www/static/;
            try_files $uri =404;
            expires 30d;
            # 优化：添加 Cache-Control
            add_header Cache-Control "public, must-revalidate";
        }

        # Admin 媒体文件
        location /media {
            alias /var/www/media/;
            try_files $uri =404;
            expires 7d;
            # 优化：添加 Cache-Control
            add_header Cache-Control "public, must-revalidate";
        }

        # Admin 后端应用代理
        location / {
            # 优化：使用 upstream
            proxy_pass http://admin_backend/; 
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 支持 WebSocket (如果 admin 后端需要)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}