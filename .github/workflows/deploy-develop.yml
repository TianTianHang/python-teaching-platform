name: Deploy to Test Server (develop)

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test

    steps:
      # ======================
      # 1. 检出代码
      # ======================
      - name: Checkout code
        uses: actions/checkout@v4
      # ======================
      # 2. 构建前端 (jupyterlite)
      # ======================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: jupyterlite-env
          init-shell: bash

      - name: Install dependencies with uv
        working-directory: ./frontend/JupyterLite
        run: uv sync --all-extras

      - name: Build JupyterLite
        working-directory: ./frontend/JupyterLite
        run: jupyter lite build --output-dir dist
      - name: Move build jupyterlite to web-student
        working-directory: ./frontend/JupyterLite
        run: |
          mkdir -p ../web-student/public/jupyterlite
          mv dist/* ../web-student/public/jupyterlite
          rmdir dist  # 可选：清理空的 dist 目录
      # ======================
      # ======================
      # 2. 构建前端 (web-student)
      # ======================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build web-student frontend
        working-directory: ./frontend/web-student
        run: |
          pnpm install
          pnpm run build

      # ======================
      # 3. 上传前端构建产物
      # ======================
      - name: Upload frontend build to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          source: "frontend/web-student/build/client/*"
          target: "/var/www/frontend/"
          rm: true

      - name: Upload SSR build to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          source: "frontend/web-student/**"
          target: "/opt/web-student/"
          strip_components: 1 
          rm: true
      # ======================
      # 4. 上传后端源码（用于在服务器上 sync + collectstatic）
      # ======================
      - name: Upload backend source to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          source: "backend/**"
          target: "/opt/backend/"
          strip_components: 1  # 去掉 backend/ 前缀，直接放文件到 /opt/backend/
          rm: true

      # ======================
      # 5. 在服务器上完成部署
      # ======================
      - name: Finalize deployment on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "=== Starting deployment ==="

            # 修复前端目录权限（Nginx 需要读取）
            sudo chown -R www-data:www-data /var/www/frontend
            sudo chmod -R 755 /var/www/frontend

            # 确保 static 和 media 目录存在（安全起见）
            sudo mkdir -p /var/www/static /var/www/media
            sudo chown backend:www-data /var/www/static /var/www/media
            sudo chmod 775 /var/www/static /var/www/media

            # 切换到后端目录，同步依赖并执行 Django 命令
            cd /opt/backend

            # 同步 Python 依赖（使用阿里云镜像加速）
            sudo -u backend uv sync --index-url='http://mirrors.cloud.aliyuncs.com/pypi/simple/'

            # 执行数据库迁移
            sudo -u backend uv run python manage.py migrate --noinput

            # 收集静态文件到 /var/www/static （需 settings.py 中 STATIC_ROOT = '/var/www/static'）
            sudo -u backend uv run python manage.py collectstatic --noinput --clear

            # 重启服务
            sudo systemctl restart backend web-student
            sudo systemctl reload nginx  # 或 restart，如果前端也变了

            echo "✅ Deployment completed!"